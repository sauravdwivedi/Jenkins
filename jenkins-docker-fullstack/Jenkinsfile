def forceBuild = true

pipeline {
    environment {
        WORK_DIR = "$WORKSPACE/jenkins-docker-fullstack"
        REGISTRY = 'sauravdwivedi'
        REGISTRY_CREDENTIAL = credentials('dockerhub_id')
        IMAGE_NAME_BACKEND = 'jenkins-docker-fullstack-backend'
        IMAGE_NAME_FRONTEND = 'jenkins-docker-fullstack-frontend'
        DOCKER_COMPOSE_FILE = 'jenkins-docker-fullstack/compose.yaml'
        CONTAINER_LOG = '**************************************************container-logs**************************************************'
    }
    agent any
    stages {
        stage('Log in to docker registry') {
            steps {
                script {
                    sh "docker login -u $REGISTRY_CREDENTIAL_USR -p $REGISTRY_CREDENTIAL_PSW"
                }
            }
        }
        stage('Build, tag and push backend container') {
            when {
                anyOf {
                    changeset "$WORK_DIR/backend/**"
                    expression {forceBuild == true}
                }
            }
            steps {
                script {
                    dockerImageBackend = docker.build(
                        "$REGISTRY/$IMAGE_NAME_BACKEND:$BUILD_NUMBER", 
                        ".$WORK_DIR/backend"
                    )
                    dockerImageBackend.push()
                    dockerImageBackend.push('latest')
                }
            }
        }
        stage('Build, tag and push frontend container') {
            when {
                anyOf {
                    changeset "$WORK_DIR/frontend/**"
                    expression {forceBuild == true}
                }
            }
            steps {
                script {
                    dockerImageFrontend = docker.build(
                        "$REGISTRY/$IMAGE_NAME_FRONTEND:$BUILD_NUMBER", 
                        "./$WORK_DIR/frontend"
                    )
                    dockerImageFrontend.push()
                    dockerImageFrontend.push('latest')
                }
            }
        }
        stage('Deploy backend container') {
            when {
                anyOf {
                    changeset "$WORK_DIR/backend/**"
                    expression {forceBuild == true}
                }
            }
            // steps {
            //     sh 'docker stop jenkins-backend || true && docker rm jenkins-backend || true'
            //     sh "docker run --name jenkins-backend -d -p 5000:5000 $dockerImageBackend.id"
            // }
            steps {
                sh "docker compose -f ${DOCKER_COMPOSE_FILE} up -d backend"
            }
        }
        stage('Deploy frontend container') {
            when {
                anyOf {
                    changeset "$WORK_DIR/frontend/**"
                    expression {forceBuild == true}
                }
            }
            steps {
                sh "docker compose -f ${DOCKER_COMPOSE_FILE} up -d frontend"
            }
        }
        stage('Check backend container logs') {
            steps {
                sh(returnStdout: true, returnStatus: true, script: "echo $CONTAINER_LOG")
                sh 'docker logs jenkins-backend || true'
            }
        }
        stage('Check frontend container logs') {
            steps {
                sh(returnStdout: true, returnStatus: true, script: "echo $CONTAINER_LOG")
                sh 'docker logs jenkins-frontend || true'
            }
        }
    }
}