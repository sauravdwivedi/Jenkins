pipeline {
    environment {
        registry = "sauravdwivedi/jenkins-docker-fullstack"
        registryCredential = 'dockerhub_id'
        dockerImage = ''
        forceBuild = true
        containerLog = "***************************************************container-logs***************************************************"
    }
    agent any
    stages {
        stage('Build, tag and push backend container') {
            when {
                anyOf {
                    changeset 'jenkins-docker-fullstack/backend/**'
                    expression {$forceBuild == true}
                }
            }
            steps {
                script {
                    dockerImage = docker.build("$registry/jenkins-backend:$BUILD_NUMBER", "./jenkins-docker-fullstack/backend")
                }
                script {
                    docker.withRegistry(registry, registryCredential) {
                        dockerImage.push()
                    }
                }
            }
        }
        stage('Deploy backend container') {
            when {
                anyOf {
                    changeset 'jenkins-docker-fullstack/backend/**'
                    expression {true}
                }
            }
            steps {
                sh 'docker stop jenkins-backend || true && docker rm jenkins-backend || true'
                sh 'docker run --name jenkins-backend -d -p 5000:5000 $registry/jenkins-backend:$BUILD_NUMBER'
            }
        }
        stage('Check backend container logs') {
            steps {
                sh(returnStdout: true, returnStatus: true, script: 'echo $containerLog')
                sh 'docker logs jenkins-backend'
            }
        }
    }
}